@page "/order-details/{OrderId:int}"
@using JewShop.Client.Services
@using JewShop.Shared.Dtos
@inject OrderService OrderService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Chi ti·∫øt ƒë∆°n h√†ng - JewShop</PageTitle>

<Toast @ref="toast" />

<div class="order-details-page">
    @if (isLoading)
    {
        <div class="loading">
            <p>ƒêang t·∫£i th√¥ng tin ƒë∆°n h√†ng...</p>
        </div>
    }
    else if (order == null)
    {
        <div class="not-found">
            <h2>Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng</h2>
            <p>ƒê∆°n h√†ng b·∫°n ƒëang t√¨m kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a.</p>
            <a href="/profile" class="btn-back">‚Üê Quay l·∫°i h·ªì s∆°</a>
        </div>
    }
    else
    {
        <div class="order-container">
            <div class="order-header">
                <div>
                    <h1>Chi ti·∫øt ƒë∆°n h√†ng</h1>
                    <p class="order-code">M√£ ƒë∆°n: <strong>#@order.OrderCode</strong></p>
                </div>
                <a href="/profile" class="btn-back">‚Üê Quay l·∫°i</a>
            </div>

            <div class="order-content">
                <!-- Order Status Card -->
                <div class="info-card">
                    <h3>Tr·∫°ng th√°i ƒë∆°n h√†ng</h3>
                    <div class="status-info">
                        <div class="status-item">
                            <span class="label">Tr·∫°ng th√°i:</span>
                            @if(order.Status == "completed") 
                            { 
                                <span class="badge badge-success">‚úì Ho√†n th√†nh</span> 
                            }
                            else if(order.Status == "pending") 
                            { 
                                <span class="badge badge-warning">‚è≥ Ch·ªù x·ª≠ l√Ω</span> 
                            }
                            else if(order.Status == "processing") 
                            { 
                                <span class="badge badge-info">üîÑ ƒêang x·ª≠ l√Ω</span> 
                            }
                            else if(order.Status == "shipped") 
                            { 
                                <span class="badge badge-primary">üöö ƒêang giao</span> 
                            }
                            else if(order.Status == "cancelled") 
                            { 
                                <span class="badge badge-danger">‚úï ƒê√£ h·ªßy</span> 
                            }
                            else 
                            { 
                                <span class="badge badge-secondary">@order.Status</span> 
                            }
                        </div>
                        <div class="status-item">
                            <span class="label">Ng√†y ƒë·∫∑t:</span>
                            <span class="value">@order.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                        </div>
                    </div>

                    @if (CanCancelOrder())
                    {
                        <button class="btn-cancel" @onclick="HandleCancelOrder">
                            ‚úï H·ªßy ƒë∆°n h√†ng
                        </button>
                    }
                </div>

                <!-- Customer Info Card -->
                <div class="info-card">
                    <h3>Th√¥ng tin giao h√†ng</h3>
                    <div class="customer-info">
                        <div class="info-row">
                            <span class="label">Ng∆∞·ªùi nh·∫≠n:</span>
                            <span class="value">@order.CustomerName</span>
                        </div>
                        <div class="info-row">
                            <span class="label">S·ªë ƒëi·ªán tho·∫°i:</span>
                            <span class="value">@order.CustomerPhone</span>
                        </div>
                        <div class="info-row">
                            <span class="label">ƒê·ªãa ch·ªâ:</span>
                            <span class="value">@order.ShippingAddress</span>
                        </div>

                    </div>
                </div>

                <!-- Order Items Card -->
                <div class="info-card">
                    <h3>S·∫£n ph·∫©m ƒë√£ ƒë·∫∑t</h3>
                    <div class="items-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>S·∫£n ph·∫©m</th>
                                    <th>ƒê∆°n gi√°</th>
                                    <th>S·ªë l∆∞·ª£ng</th>
                                    <th>Th√†nh ti·ªÅn</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in order.OrderItems)
                                {
                                    <tr>
                                        <td>
                                            <div class="product-info">
                                                <strong>@item.ProductName</strong>
                                                @if (!string.IsNullOrEmpty(item.Size) || !string.IsNullOrEmpty(item.Color))
                                                {
                                                    <small>
                                                        @if (!string.IsNullOrEmpty(item.Size)) { <span>Size: @item.Size</span> }
                                                        @if (!string.IsNullOrEmpty(item.Color)) { <span>M√†u: @item.Color</span> }
                                                    </small>
                                                }
                                            </div>
                                        </td>
                                        <td>@item.UnitPrice.ToString("N0") ‚Ç´</td>
                                        <td>@item.Quantity</td>
                                        <td class="total">@item.TotalPrice.ToString("N0") ‚Ç´</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Price Summary Card -->
                <div class="info-card">
                    <h3>T·ªïng quan thanh to√°n</h3>
                    <div class="price-summary">
                        <div class="price-row">
                            <span>T·∫°m t√≠nh:</span>
                            <span>@order.Subtotal.ToString("N0") ‚Ç´</span>
                        </div>
                        <div class="price-row">
                            <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                            <span>@order.ShippingFee.ToString("N0") ‚Ç´</span>
                        </div>
                        @if (order.DiscountAmount > 0)
                        {
                            <div class="price-row discount">
                                <span>Gi·∫£m gi√°:</span>
                                <span>-@order.DiscountAmount.ToString("N0") ‚Ç´</span>
                            </div>
                        }
                        <div class="price-row total">
                            <span>T·ªïng c·ªông:</span>
                            <span>@order.TotalAmount.ToString("N0") ‚Ç´</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int OrderId { get; set; }

    private OrderDto? order;
    private bool isLoading = true;
    private Toast? toast;

    protected override async Task OnInitializedAsync()
    {
        await LoadOrder();
    }

    private async Task LoadOrder()
    {
        isLoading = true;
        try
        {
            order = await OrderService.GetOrderById(OrderId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading order: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private bool CanCancelOrder()
    {
        if (order == null) return false;
        return order.Status == "pending" || order.Status == "processing";
    }

    private async Task HandleCancelOrder()
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?");
        if (!confirmed) return;

        try
        {
            var success = await OrderService.CancelOrder(OrderId);
            if (success)
            {
                toast?.Show("Th√†nh c√¥ng", "ƒê√£ h·ªßy ƒë∆°n h√†ng!", Toast.ToastType.Success);
                await Task.Delay(1500);
                Navigation.NavigateTo("/profile");
            }
            else
            {
                toast?.Show("L·ªói", "Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i.", Toast.ToastType.Error);
            }
        }
        catch (Exception ex)
        {
            toast?.Show("L·ªói", $"ƒê√£ x·∫£y ra l·ªói: {ex.Message}", Toast.ToastType.Error);
        }
    }
}
