@page "/admin/imports"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "admin")]
@layout AdminLayout
@inject HttpClient Http
@inject IJSRuntime JS

<div class="row mb-4 align-items-center">
    <div class="col">
        <h2 class="fw-bold mb-0">Quản lý Nhập kho</h2>
        <p class="text-muted">Quản lý phiếu nhập hàng và cập nhật tồn kho</p>
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" @onclick="ShowCreateModal">
            <i class="bi bi-plus-circle me-2"></i>Tạo phiếu nhập
        </button>
    </div>
</div>

@if (imports == null)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="text-muted mt-2">Đang tải...</p>
    </div>
}
else if (!imports.Any())
{
    <div class="card shadow-sm border-0">
        <div class="card-body text-center py-5">
            <img src="assets/icons/import.svg" style="width: 64px; opacity: 0.5;" class="mb-3" />
            <h5 class="text-muted">Chưa có phiếu nhập nào</h5>
            <button class="btn btn-primary mt-3" @onclick="ShowCreateModal">Tạo phiếu nhập đầu tiên</button>
        </div>
    </div>
}
else
{
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4 border-0">Mã phiếu</th>
                            <th class="border-0">Nhà cung cấp</th>
                            <th class="border-0">Ngày nhập</th>
                            <th class="border-0">Tổng tiền</th>
                            <th class="border-0">Trạng thái</th>
                            <th class="border-0 text-end pe-4">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var import in imports)
                        {
                            <tr>
                                <td class="ps-4 fw-bold text-primary">@import.ImportCode</td>
                                <td>@import.SupplierName</td>
                                <td class="text-muted small">@import.ImportDate.ToString("dd/MM/yyyy HH:mm")</td>
                                <td class="fw-bold">@import.TotalAmount.ToString("N0") ₫</td>
                                <td>
                                    @if(import.Status == "completed") { <span class="badge bg-success">Hoàn thành</span> }
                                    else if(import.Status == "pending") { <span class="badge bg-warning">Chờ duyệt</span> }
                                    else { <span class="badge bg-danger">Đã hủy</span> }
                                </td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => ViewDetails(import.Id)">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    @if (import.Status == "pending")
                                    {
                                        <button class="btn btn-sm btn-success me-1" @onclick="() => CompleteImport(import.Id)">
                                            <i class="bi bi-check-circle"></i> Duyệt
                                        </button>
                                        <button class="btn btn-sm btn-danger" @onclick="() => CancelImport(import.Id)">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@if (showCreateModal)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Tạo phiếu nhập mới</h5>
                    <button type="button" class="btn-close" @onclick="() => showCreateModal = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nhà cung cấp</label>
                        <select class="form-select" @bind="newImport.SupplierId">
                            <option value="0">-- Chọn nhà cung cấp --</option>
                            @foreach (var supplier in suppliers)
                            {
                                <option value="@supplier.Id">@supplier.Name</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Ghi chú</label>
                        <textarea class="form-control" rows="2" @bind="newImport.Note"></textarea>
                    </div>

                    <hr />

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0 fw-bold">Danh sách sản phẩm</h6>
                        <button class="btn btn-sm btn-outline-primary" @onclick="AddImportItem">
                            <i class="bi bi-plus"></i> Thêm sản phẩm
                        </button>
                    </div>

                    @foreach (var item in newImport.Items)
                    {
                        var index = newImport.Items.IndexOf(item);
                        <div class="card mb-2">
                            <div class="card-body p-3">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <label class="form-label small">Variant ID</label>
                                        <input type="number" class="form-control form-control-sm" @bind="item.VariantId" />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Số lượng</label>
                                        <input type="number" class="form-control form-control-sm" @bind="item.Quantity" />
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Giá nhập</label>
                                        <input type="number" class="form-control form-control-sm" @bind="item.UnitPrice" />
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button class="btn btn-sm btn-danger w-100" @onclick="() => RemoveImportItem(index)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <div class="alert alert-info mt-3">
                        <strong>Tổng tiền:</strong> @CalculateTotal().ToString("N0") ₫
                    </div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-light" @onclick="() => showCreateModal = false">Hủy</button>
                    <button type="button" class="btn btn-primary" @onclick="HandleCreateImport">Tạo phiếu nhập</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<ImportDto>? imports;
    private List<SupplierDto> suppliers = new();
    private bool showCreateModal = false;
    private CreateImportDto newImport = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        await LoadSuppliers();
    }

    private async Task LoadData()
    {
        try
        {
            imports = await Http.GetFromJsonAsync<List<ImportDto>>("api/imports");
        }
        catch
        {
            imports = new List<ImportDto>();
        }
    }

    private async Task LoadSuppliers()
    {
        try
        {
            suppliers = await Http.GetFromJsonAsync<List<SupplierDto>>("api/suppliers") ?? new();
        }
        catch
        {
            suppliers = new List<SupplierDto>();
        }
    }

    private void ShowCreateModal()
    {
        newImport = new CreateImportDto();
        newImport.Items.Add(new CreateImportItemDto());
        showCreateModal = true;
    }

    private void AddImportItem()
    {
        newImport.Items.Add(new CreateImportItemDto());
    }

    private void RemoveImportItem(int index)
    {
        newImport.Items.RemoveAt(index);
    }

    private decimal CalculateTotal()
    {
        return newImport.Items.Sum(i => i.Quantity * i.UnitPrice);
    }

    private async Task HandleCreateImport()
    {
        if (newImport.SupplierId == 0)
        {
            await JS.InvokeVoidAsync("alert", "Vui lòng chọn nhà cung cấp");
            return;
        }

        if (!newImport.Items.Any())
        {
            await JS.InvokeVoidAsync("alert", "Vui lòng thêm ít nhất 1 sản phẩm");
            return;
        }

        try
        {
            var response = await Http.PostAsJsonAsync("api/imports", newImport);
            if (response.IsSuccessStatusCode)
            {
                showCreateModal = false;
                await LoadData();
                await JS.InvokeVoidAsync("alert", "Tạo phiếu nhập thành công!");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Lỗi: Không thể tạo phiếu nhập");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Lỗi: {ex.Message}");
        }
    }

    private async Task CompleteImport(int id)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Xác nhận hoàn thành phiếu nhập? Stock sẽ được cập nhật.");
        if (!confirmed) return;

        try
        {
            var response = await Http.PutAsync($"api/imports/{id}/complete", null);
            if (response.IsSuccessStatusCode)
            {
                await LoadData();
                await JS.InvokeVoidAsync("alert", "Đã hoàn thành phiếu nhập và cập nhật kho!");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Không thể hoàn thành phiếu nhập");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Lỗi: {ex.Message}");
        }
    }

    private async Task CancelImport(int id)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Xác nhận hủy phiếu nhập?");
        if (!confirmed) return;

        try
        {
            var response = await Http.PutAsync($"api/imports/{id}/cancel", null);
            if (response.IsSuccessStatusCode)
            {
                await LoadData();
                await JS.InvokeVoidAsync("alert", "Đã hủy phiếu nhập");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Lỗi: {ex.Message}");
        }
    }

    private async Task ViewDetails(int id)
    {
        // TODO: Navigate to details page or show modal
        await JS.InvokeVoidAsync("alert", $"View details for import #{id}");
    }
}
