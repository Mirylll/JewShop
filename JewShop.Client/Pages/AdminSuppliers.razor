@page "/admin/suppliers"
@layout AdminLayout

@using System.ComponentModel.DataAnnotations
@using JewShop.Client.Services
@using JewShop.Shared.Dtos
@inject SupplierDataService SupplierService
@inject IJSRuntime JsRuntime

<PageTitle>Nhà cung cấp</PageTitle>

<div class="supplier-page">
    <div class="supplier-header">
        <div>
            <p class="eyebrow">Quản lý</p>
            <h1>Nhà cung cấp</h1>
        </div>
        <button type="button" class="primary" @onclick="OpenCreateModal">+ Nhà cung cấp</button>
    </div>

    <div class="supplier-toolbar">
        <input class="search" type="search" placeholder="Tìm kiếm theo tên, email hoặc số điện thoại" @bind="searchTerm" @bind:event="oninput" />
        <button type="button" class="ghost" @onclick="ApplySearch">Tìm</button>
        <button type="button" class="ghost" @onclick="Refresh">Làm mới</button>
    </div>

    @if (!string.IsNullOrEmpty(pageError))
    {
        <div class="alert alert-error">@pageError</div>
    }

    @if (isLoading)
    {
        <p class="muted">Đang tải dữ liệu...</p>
    }
    else if (suppliers.Count == 0)
    {
        <div class="empty-state">
            <p>Chưa có nhà cung cấp nào. Hãy thêm mới để bắt đầu quản lý.</p>
        </div>
    }
    else
    {
        <div class="table-wrapper">
            <table class="supplier-table">
                <thead>
                    <tr>
                        <th>Tên</th>
                        <th>Điện thoại</th>
                        <th>Email</th>
                        <th>Địa chỉ</th>
                        <th class="actions">Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var supplier in suppliers)
                    {
                        <tr>
                            <td>
                                <strong>@supplier.Name</strong>
                            </td>
                            <td>@(string.IsNullOrWhiteSpace(supplier.Phone) ? "-" : supplier.Phone)</td>
                            <td>@(string.IsNullOrWhiteSpace(supplier.Email) ? "-" : supplier.Email)</td>
                            <td>@(string.IsNullOrWhiteSpace(supplier.Address) ? "-" : supplier.Address)</td>
                            <td class="actions">
                                <button type="button" class="link" @onclick="() => EditSupplier(supplier)">Sửa</button>
                                <button type="button" class="link danger" @onclick="() => DeleteSupplier(supplier)">Xoá</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@if (isModalOpen)
{
    <div class="supplier-modal-overlay" role="dialog" aria-modal="true" aria-label="@(isEditMode ? "Cập nhật nhà cung cấp" : "Thêm nhà cung cấp")" @onclick="CloseModal">
        <div class="supplier-modal" @onclick:stopPropagation>
            <div class="supplier-modal-header">
                <h3>@(isEditMode ? "Cập nhật nhà cung cấp" : "Thêm nhà cung cấp")</h3>
                <button type="button" class="icon" @onclick="CloseModal" aria-label="Đóng">×</button>
            </div>

            <EditForm Model="formModel" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />
                @if (!string.IsNullOrEmpty(modalError))
                {
                    <div class="alert alert-error">@modalError</div>
                }

                <div class="form-grid">
                    <label>Tên nhà cung cấp</label>
                    <InputText @bind-Value="formModel.Name" />
                    <ValidationMessage For="() => formModel.Name" />

                    <label>Số điện thoại</label>
                    <InputText @bind-Value="formModel.Phone" />
                    <ValidationMessage For="() => formModel.Phone" />

                    <label>Email</label>
                    <InputText @bind-Value="formModel.Email" />
                    <ValidationMessage For="() => formModel.Email" />

                    <label>Địa chỉ</label>
                    <InputText @bind-Value="formModel.Address" />
                    <ValidationMessage For="() => formModel.Address" />
                </div>

                <div class="supplier-modal-actions">
                    <button type="button" class="ghost" @onclick="CloseModal">Huỷ</button>
                    <button type="submit" class="primary" disabled="@isSaving">@(isSaving ? "Đang lưu..." : "Lưu")</button>
                </div>
            </EditForm>
        </div>
    </div>
}

@code {
    private readonly SupplierFormModel formModel = new();
    private List<SupplierDto> suppliers = new();
    private bool isLoading;
    private bool isModalOpen;
    private bool isEditMode;
    private bool isSaving;
    private int? editingSupplierId;
    private string? searchTerm;
    private string? pageError;
    private string? modalError;

    protected override async Task OnInitializedAsync()
    {
        await LoadSuppliers();
    }

    private async Task LoadSuppliers()
    {
        isLoading = true;
        pageError = null;
        try
        {
            suppliers = await SupplierService.GetAllAsync(searchTerm);
        }
        catch
        {
            pageError = "Không thể tải dữ liệu. Vui lòng thử lại.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private Task ApplySearch()
    {
        return LoadSuppliers();
    }

    private Task Refresh()
    {
        searchTerm = string.Empty;
        return LoadSuppliers();
    }

    private void OpenCreateModal()
    {
        formModel.Reset();
        isEditMode = false;
        isModalOpen = true;
        modalError = null;
        editingSupplierId = null;
        StateHasChanged();
    }

    private void EditSupplier(SupplierDto supplier)
    {
        formModel.SetFromDto(supplier);
        isEditMode = true;
        isModalOpen = true;
        modalError = null;
        editingSupplierId = supplier.Id;
        StateHasChanged();
    }

    private void CloseModal()
    {
        isModalOpen = false;
        modalError = null;
        formModel.Reset();
        StateHasChanged();
    }

    private async Task HandleSubmit()
    {
        if (isSaving)
        {
            return;
        }

        modalError = null;
        isSaving = true;

        try
        {
            if (isEditMode && editingSupplierId.HasValue)
            {
                var dto = formModel.ToUpdateDto();
                var updated = await SupplierService.UpdateAsync(editingSupplierId.Value, dto);
                if (updated == null)
                {
                    modalError = "Nhà cung cấp không tồn tại nữa.";
                    return;
                }
            }
            else
            {
                var dto = formModel.ToCreateDto();
                var created = await SupplierService.CreateAsync(dto);
                if (created == null)
                {
                    modalError = "Không thể tạo nhà cung cấp.";
                    return;
                }
            }

            await LoadSuppliers();
            CloseModal();
        }
        catch
        {
            modalError = "Có lỗi xảy ra. Vui lòng thử lại.";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteSupplier(SupplierDto supplier)
    {
        var confirmed = await JsRuntime.InvokeAsync<bool>("confirm", $"Xoá nhà cung cấp '{supplier.Name}'?");
        if (!confirmed)
        {
            return;
        }

        var deleted = await SupplierService.DeleteAsync(supplier.Id);
        if (!deleted)
        {
            pageError = "Không thể xoá nhà cung cấp.";
            return;
        }

        await LoadSuppliers();
    }

    private class SupplierFormModel
    {
        [Required(ErrorMessage = "Vui lòng nhập tên nhà cung cấp.")]
        [MaxLength(200)]
        public string Name { get; set; } = string.Empty;

        [MaxLength(50)]
        public string? Phone { get; set; }

        [EmailAddress]
        [MaxLength(100)]
        public string? Email { get; set; }

        [MaxLength(300)]
        public string? Address { get; set; }

        public void Reset()
        {
            Name = string.Empty;
            Phone = null;
            Email = null;
            Address = null;
        }

        public void SetFromDto(SupplierDto dto)
        {
            Name = dto.Name;
            Phone = dto.Phone;
            Email = dto.Email;
            Address = dto.Address;
        }

        public CreateSupplierDto ToCreateDto()
        {
            return new CreateSupplierDto
            {
                Name = Name.Trim(),
                Phone = string.IsNullOrWhiteSpace(Phone) ? null : Phone.Trim(),
                Email = string.IsNullOrWhiteSpace(Email) ? null : Email.Trim(),
                Address = string.IsNullOrWhiteSpace(Address) ? null : Address.Trim()
            };
        }

        public UpdateSupplierDto ToUpdateDto()
        {
            return new UpdateSupplierDto
            {
                Name = Name.Trim(),
                Phone = string.IsNullOrWhiteSpace(Phone) ? null : Phone.Trim(),
                Email = string.IsNullOrWhiteSpace(Email) ? null : Email.Trim(),
                Address = string.IsNullOrWhiteSpace(Address) ? null : Address.Trim()
            };
        }
    }
}
